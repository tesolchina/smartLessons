<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKBU Basic Chat Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 90vh;
            min-height: 600px;
        } 

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-footer {
            padding: 15px;
            background: #e9ecef;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }

        .prompt-section {
            margin-bottom: 20px;
        }

        .api-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .api-section h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .api-instructions {
            font-size: 0.85rem;
            color: #856404;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .api-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .connection-status {
            font-size: 0.8rem;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .prompt-header h3 {
            font-size: 1rem;
            color: #333;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .prompt-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .prompt-content {
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .prompt-content.hidden {
            display: none;
        }

        .prompt-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .prompt-editor {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            font-family: inherit;
            resize: vertical;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            max-height: calc(100vh - 200px);
            min-height: 300px;
            scroll-behavior: smooth;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            line-height: 1.4;
            max-width: min(70%, 500px);
            word-break: break-word;
            hyphens: auto;
        } 

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user { flex-direction: row-reverse; }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-right: 10px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            margin-left: 10px;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 45px;
        }

        .chat-input:focus { border-color: #667eea; }

        .input-buttons {
            display: flex;
            gap: 10px;
        }

        .send-btn, .done-btn {
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .done-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .send-btn:hover, .done-btn:hover { transform: scale(1.05); }
        .send-btn:disabled, .done-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .report-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .sidebar {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ü§ñ HKBU Chat Assistant</h2>
                <p>Customize your learning experience</p>
            </div>
            
            <div class="sidebar-content">
                <!-- API Configuration Section (Top Priority) -->
                <div class="api-section">
                    <h3>üîë API Configuration</h3>
                    <div class="api-instructions">
                        <strong>Step 1:</strong> Get your API key from <a href="https://genai.hkbu.edu.hk/settings/api-docs" target="_blank" style="color: #667eea;">HKBU GenAI Platform</a><br>
                        <strong>Step 2:</strong> Copy and paste your API key below<br>
                        <strong>Step 3:</strong> Click "Test Connection" to verify
                    </div>
                    
                    <input 
                        type="password" 
                        id="api-key" 
                        class="api-key-input"
                        placeholder="Paste your HKBU GenAI API key here..."
                    >
                    
                    <div class="api-buttons">
                        <button class="btn btn-info btn-sm" onclick="testConnection()">üîç Test</button>
                        <button class="btn btn-success btn-sm" onclick="connectAPI()" id="connect-btn" disabled>‚úÖ Connect</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAPI()">üóëÔ∏è Clear</button>
                    </div>
                    
                    <div id="connection-status" class="connection-status" style="display: none;"></div>
                </div>

                <!-- Welcome Prompt Section -->
                <div class="prompt-section">
                    <div class="prompt-header" onclick="togglePrompt('welcome')">
                        <h3>üìù Welcome Message</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-content" id="welcome-content">
                        <div class="prompt-display" id="welcome-display">Loading welcome message from file...</div>
                        <button class="btn btn-primary" onclick="editPrompt('welcome')">Edit Welcome</button>
                        <button class="btn btn-secondary" onclick="resetPrompt('welcome')">Reset</button>
                    </div>
                </div>

                <!-- System Prompt Section -->
                <div class="prompt-section">
                    <div class="prompt-header" onclick="togglePrompt('system')">
                        <h3>‚öôÔ∏è System Instructions</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-content" id="system-content">
                        <div class="prompt-display" id="system-display">Loading system instructions from file...</div>
                        <button class="btn btn-primary" onclick="editPrompt('system')">Edit System</button>
                        <button class="btn btn-secondary" onclick="resetPrompt('system')">Reset</button>
                        <div style="margin-top: 10px;">
                            <small style="color: #666;">üí° Try roles like: Math Tutor, Writing Coach, Research Assistant, Language Partner</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credits Footer -->
            <div class="sidebar-footer">
                <strong>Created by:</strong><br>
                Dr. Simon Wang<br>
                Innovation Officer, Language Centre<br>
                Hong Kong Baptist University<br>
                <a href="mailto:simonwang@hkbu.edu.hk" style="color: #667eea;">simonwang@hkbu.edu.hk</a>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h1>HKBU Learning Assistant</h1>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    üí° Customize prompts, chat, and generate learning reports
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    <div class="message-content">
                        üîë Please configure your API key first to start chatting!<br><br>
                        Follow the instructions in the sidebar to get your HKBU GenAI API key and test the connection.
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="message-input" 
                        placeholder="Connect your API key first to start chatting..."
                        rows="1"
                        disabled
                    ></textarea>
                    <div class="input-buttons">
                        <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled title="Send Message">
                            ‚û§
                        </button>
                        <button class="done-btn" id="done-btn" onclick="generateReport()" disabled title="Generate Report">
                            ‚úì
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-content">
            <button class="close-btn" onclick="closeReport()">&times;</button>
            <div id="report-content">
                <!-- Report will be generated here -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button class="btn btn-primary" onclick="downloadMarkdown()">üìù Download Markdown</button>
                <button class="btn btn-secondary" onclick="copyReport()">üìã Copy Text</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chatHistory = [];
        let isConnected = false;
        let apiKey = '';
        let welcomePrompt = '';
        let systemPrompt = '';
        let defaultWelcome = '';
        let defaultSystem = '';
        const STORAGE_KEYS = {
            API_KEY: 'hkbu_chat_api_key',
            CHAT_HISTORY: 'hkbu_chat_current_session',
            PREFERENCES: 'hkbu_chat_preferences'
        };

        let userPreferences = {
            rememberApiKey: true,
            saveConversations: true,
            autoRestore: true
        };
        // Warn user before leaving if they have unsaved chat
        window.addEventListener('beforeunload', function(e) {
            if (chatHistory.length > 0 && userPreferences.saveConversations) {
                e.preventDefault();
                e.returnValue = 'You have an active chat session. Are you sure you want to leave?';
                return 'You have an active chat session. Are you sure you want to leave?';
            }
        });

       
        // Initialize
            document.addEventListener('DOMContentLoaded', function() {
            // Load user preferences first
            loadPreferencesFromCache();
            
            // Load prompts from files
            loadPrompts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Try to restore API key
            const cachedApiKey = loadApiKeyFromCache();
            if (cachedApiKey) {
                document.getElementById('connect-btn').disabled = false;
                showNotification('API key restored from cache', 'info');
            }
            
            // Check for previous chat session
            checkForPreviousSession();
        });

        function checkForPreviousSession() {
            const sessionData = loadChatHistoryFromCache();
            if (sessionData && sessionData.messages.length > 0) {
                const timeDiff = new Date() - new Date(sessionData.lastActivity);
                const hoursSinceLastActivity = timeDiff / (1000 * 60 * 60);
                
                if (hoursSinceLastActivity < 2 && userPreferences.autoRestore) {
                    // Auto-restore recent sessions
                    restoreSession(sessionData);
                    showNotification(`Previous session restored (${sessionData.messageCount} messages)`, 'success');
                } else if (hoursSinceLastActivity < 24) {
                    // Prompt user for older sessions
                    showSessionRestorePrompt(sessionData);
                } else {
                    // Clear very old sessions
                    clearCache(STORAGE_KEYS.CHAT_HISTORY);
                }
            }
        }

        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // Auto-enable connect button when API key is entered
            document.getElementById('api-key').addEventListener('input', function() {
                const connectBtn = document.getElementById('connect-btn');
                if (this.value.trim()) {
                    connectBtn.disabled = false;
                } else {
                    connectBtn.disabled = true;
                }
            });
        }

        function showSessionRestorePrompt(sessionData) {
            const timeDiff = new Date() - new Date(sessionData.lastActivity);
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            const timeAgo = hours > 0 ? `${hours}h ${minutes}m ago` : `${minutes}m ago`;
            
            // Create restore banner
            const banner = document.createElement('div');
            banner.id = 'session-restore-banner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px;
                text-align: center;
                z-index: 3000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            
            banner.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <strong>üìö Previous learning session found</strong><br>
                    ${sessionData.messageCount} messages ‚Ä¢ ${timeAgo}
                    <div style="margin-top: 10px;">
                        <button onclick="restoreSession(${JSON.stringify(sessionData).replace(/"/g, '&quot;')}); closeBanner()" 
                                style="background: white; color: #667eea; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
                            Continue Session
                        </button>
                        <button onclick="startFreshSession(); closeBanner()" 
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 16px; margin: 0 5px; border-radius: 5px; cursor: pointer;">
                            Start Fresh
                        </button>
                        <button onclick="closeBanner()" 
                                style="background: none; color: white; border: none; padding: 8px 16px; margin: 0 5px; cursor: pointer; text-decoration: underline;">
                            Decide Later
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(banner);
        }

        function restoreSession(sessionData) {
            try {
                // Restore chat history
                chatHistory = sessionData.messages.map(msg => ({
                    ...msg,
                    timestamp: new Date(msg.timestamp)
                }));
                
                // Restore custom prompts if they exist
                if (sessionData.customPrompts) {
                    if (sessionData.customPrompts.welcome) {
                        welcomePrompt = sessionData.customPrompts.welcome;
                        updatePromptDisplay('welcome');
                    }
                    if (sessionData.customPrompts.system) {
                        systemPrompt = sessionData.customPrompts.system;
                        updatePromptDisplay('system');
                    }
                }
                
                // Restore chat display
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';
                
                chatHistory.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
                
                // Enable done button if there are messages
                if (chatHistory.length > 0) {
                    document.getElementById('done-btn').disabled = false;
                }
                
            } catch (error) {
                console.error('Failed to restore session:', error);
                showNotification('Failed to restore previous session', 'error');
                startFreshSession();
            }
        }

        function startFreshSession() {
            // Clear current session
            chatHistory = [];
            clearCache(STORAGE_KEYS.CHAT_HISTORY);
            
            // Reset chat display
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        üîë Please configure your API key first to start chatting!<br><br>
                        Follow the instructions in the sidebar to get your HKBU GenAI API key and test the connection.
                    </div>
                </div>
            `;
            
            // Disable done button
            document.getElementById('done-btn').disabled = true;
            
            showNotification('Started fresh session', 'info');
        }

        function closeBanner() {
            const banner = document.getElementById('session-restore-banner');
            if (banner) {
                banner.remove();
            }
        }

        async function loadPrompts() {
            try {
                // Load welcome prompt from backend API
                const welcomeResponse = await fetch('https://smartlessons-production.up.railway.app/prompts/welcome.txt');
                if (welcomeResponse.ok) {
                    const welcomeData = await welcomeResponse.json();
                    defaultWelcome = welcomeData.content;
                    welcomePrompt = defaultWelcome;
                    console.log('‚úÖ Welcome prompt loaded from file');
                } else {
                    throw new Error('Failed to load welcome.txt');
                }

                // Load system prompt from backend API
                const systemResponse = await fetch('https://smartlessons-production.up.railway.app/prompts/system.txt');
                if (systemResponse.ok) {
                    const systemData = await systemResponse.json();
                    defaultSystem = systemData.content;
                    systemPrompt = defaultSystem;
                    console.log('‚úÖ System prompt loaded from file');
                } else {
                    throw new Error('Failed to load system.txt');
                }

                // Update displays
                updatePromptDisplay('welcome');
                updatePromptDisplay('system');
                
                showNotification('Prompts loaded from files successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading prompts from files:', error);
                
                // Fallback to hardcoded defaults
                defaultWelcome = `Welcome to the HKBU Learning Assistant! üéì

I'm here to help you explore various topics and enhance your learning experience. You can customize my behavior by editing the system prompt below.

üîß **How to customize:**
- Click 'Edit System Prompt' to modify my personality and expertise
- Try different roles: tutor, writing coach, research assistant, etc.
- Experiment with different teaching styles

üí° **Tips:**
- Ask me to explain concepts step-by-step
- Request examples and practice problems
- Get help with assignments and projects

When you're done with our conversation, click 'Done' to generate a comprehensive learning report!

Let's start learning together!`;

                defaultSystem = `You are a knowledgeable and friendly educational assistant for HKBU students. Your role is to:

1. **Teaching Style**: Explain concepts clearly with examples, encourage critical thinking, and adapt to different learning styles.

2. **Subject Expertise**: Help with various academic subjects including language learning, sciences, humanities, and general study skills.

3. **Interaction Approach**: 
   - Ask clarifying questions to understand student needs
   - Provide step-by-step explanations
   - Encourage students to think through problems
   - Offer constructive feedback and encouragement

4. **Learning Support**: 
   - Break down complex topics into manageable parts
   - Suggest additional resources when helpful
   - Help students develop study strategies
   - Foster independent learning skills

5. **Communication**: Be encouraging, patient, and supportive. Use clear language appropriate for university-level students.

Remember: Guide students toward understanding rather than simply providing answers.`;

                welcomePrompt = defaultWelcome;
                systemPrompt = defaultSystem;
                
                updatePromptDisplay('welcome');
                updatePromptDisplay('system');
                
                showNotification('Using default prompts (files not accessible)', 'info');
            }
        }

        function togglePrompt(section) {
            const content = document.getElementById(section + '-content');
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            content.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        }

        function updatePromptDisplay(type) {
            const display = document.getElementById(type + '-display');
            const prompt = type === 'welcome' ? welcomePrompt : systemPrompt;
            display.textContent = prompt;
        }

        async function testConnection() {
            const key = document.getElementById('api-key').value.trim();
            const statusDiv = document.getElementById('connection-status');
            
            if (!key) {
                showNotification('Please enter an API key first', 'error');
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.className = 'connection-status status-loading';
            statusDiv.innerHTML = 'üîÑ Testing connection to HKBU GenAI...';
            
            try {
                const response = await fetch('https://smartlessons-production.up.railway.app/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: key,
                        provider: 'hkbu',
                        model: 'gpt-4.1'
                    })
                });

                const data = await response.json();

                if (response.ok && !data.error) {
                    statusDiv.className = 'connection-status status-success';
                    statusDiv.innerHTML = '‚úÖ Connection successful! API key is valid.';
                    document.getElementById('connect-btn').disabled = false;
                    showNotification('API key is valid!', 'success');
                } else {
                    throw new Error(data.error || 'Connection failed');
                }
            } catch (error) {
                statusDiv.className = 'connection-status status-error';
                statusDiv.innerHTML = '‚ùå Connection failed: ' + error.message;
                showNotification(`Connection test failed: ${error.message}`, 'error');
            }
        }

        async function connectAPI() {
            const key = document.getElementById('api-key').value.trim();
            
            if (!key) {
                showNotification('Please enter an API key', 'error');
                return;
            }

            apiKey = key;
            isConnected = true;
            
            // Save API key to cache
            saveApiKeyToCache();
            
            document.getElementById('message-input').disabled = false;
            document.getElementById('message-input').placeholder = 'Type your message here... (Enter to send)';
            document.getElementById('send-btn').disabled = false;
            
            // Show welcome message with loaded content
            showWelcomeMessage();
            showNotification('API connected successfully! Welcome message loaded.', 'success');
        }

        function clearAPI() {
            apiKey = '';
            isConnected = false;
            document.getElementById('api-key').value = '';
            document.getElementById('connection-status').style.display = 'none';
            document.getElementById('connect-btn').disabled = true;
            document.getElementById('message-input').disabled = true;
            document.getElementById('message-input').placeholder = 'Connect your API key first to start chatting...';
            document.getElementById('send-btn').disabled = true;
            document.getElementById('done-btn').disabled = true;
            
            // Clear API key from cache
            clearCache(STORAGE_KEYS.API_KEY);
            
            // Reset chat
            chatHistory = [];
            clearCache(STORAGE_KEYS.CHAT_HISTORY);
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        üîë Please configure your API key first to start chatting!<br><br>
                        Follow the instructions in the sidebar to get your HKBU GenAI API key and test the connection.
                    </div>
                </div>
            `;
            
            showNotification('API disconnected and cache cleared.', 'info');
        }

        function showWelcomeMessage() {
            if (!isConnected) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            const formattedWelcome = welcomePrompt
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">${formattedWelcome}</div>
                </div>
            `;
            
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function editPrompt(type) {
            const display = document.getElementById(type + '-display');
            const currentText = type === 'welcome' ? welcomePrompt : systemPrompt;
            
            const textarea = document.createElement('textarea');
            textarea.className = 'prompt-editor';
            textarea.value = currentText;
            
            display.parentNode.replaceChild(textarea, display);
            
            // Replace buttons
            const buttonsContainer = textarea.nextElementSibling;
            buttonsContainer.innerHTML = `
                <button class="btn btn-success" onclick="savePrompt('${type}')">Save</button>
                <button class="btn btn-secondary" onclick="cancelEdit('${type}')">Cancel</button>
            `;
            
            textarea.focus();
        }

        function savePrompt(type) {
            const textarea = document.querySelector('.prompt-editor');
            const newText = textarea.value;
            
            if (type === 'welcome') {
                welcomePrompt = newText;
            } else {
                systemPrompt = newText;
            }
            
            cancelEdit(type);
            // showNotification(`${type === 'welcome' ? 'Welcome' : 'System'} prompt updated! (Resets on page refresh)`, 'success');
                showNotification(`${type === 'welcome' ? 'Welcome' : 'System'} prompt updated! (Resets on page refresh)`, 'success');
                saveChatHistoryToCache();
            // Update welcome message if connected and editing welcome
            if (type === 'welcome' && isConnected) {
                showWelcomeMessage();
            }
        }

        function cancelEdit(type) {
            const textarea = document.querySelector('.prompt-editor');
            const display = document.createElement('div');
            display.className = 'prompt-display';
            display.id = type + '-display';
            
            textarea.parentNode.replaceChild(display, textarea);
            
            // Restore buttons
            const buttonsContainer = display.nextElementSibling;
            if (type === 'welcome') {
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="editPrompt('welcome')">Edit Welcome</button>
                    <button class="btn btn-secondary" onclick="resetPrompt('welcome')">Reset</button>
                `;
            } else {
                buttonsContainer.innerHTML = `
                    <button class="btn btn-primary" onclick="editPrompt('system')">Edit System</button>
                    <button class="btn btn-secondary" onclick="resetPrompt('system')">Reset</button>
                    <div style="margin-top: 10px;">
                        <small style="color: #666;">üí° Try roles like: Math Tutor, Writing Coach, Research Assistant, Language Partner</small>
                    </div>
                `;
            }
            
            updatePromptDisplay(type);
        }

        function resetPrompt(type) {
            if (type === 'welcome') {
                welcomePrompt = defaultWelcome;
            } else {
                systemPrompt = defaultSystem;
            }
            updatePromptDisplay(type);
            showNotification(`${type === 'welcome' ? 'Welcome' : 'System'} prompt reset to default`, 'info');
            
            // Update welcome message if connected and resetting welcome
            if (type === 'welcome' && isConnected) {
                showWelcomeMessage();
            }
        }

        async function sendMessage() {
            if (!isConnected) {
                showNotification('Please connect your API key first', 'error');
                return;
            }

            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage('user', message);
            //chatHistory.push({ role: 'user', content: message, timestamp: new Date() });
            chatHistory.push({ role: 'user', content: message, timestamp: new Date() });
            saveChatHistoryToCache();
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            showTyping();
            
            try {
                const response = await fetch('https://smartlessons-production.up.railway.app/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        apiKey: apiKey,
                        provider: 'hkbu',
                        model: 'gpt-4.1',
                        systemPrompt: systemPrompt
                    })
                });

                const data = await response.json();
                hideTyping();

                if (response.ok && !data.error) {
                    addMessage('assistant', data.response);
                    //chatHistory.push({ role: 'assistant', content: data.response, timestamp: new Date() });
                    chatHistory.push({ role: 'assistant', content: data.response, timestamp: new Date() });
                    saveChatHistoryToCache();
                    document.getElementById('done-btn').disabled = false;
                } else {
                    addMessage('error', `Error: ${data.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                hideTyping();
                addMessage('error', `Network error: ${error.message}`);
            }
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // Convert markdown-style formatting to HTML
            const formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')             // Italic
                .replace(/\n/g, '<br>');                          // Line breaks
            
            messageDiv.innerHTML = `
                <div class="message-content">${formattedContent}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Force scroll to bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = '<div class="message-content">ü§ñ Thinking...</div>';
            
            document.getElementById('chat-messages').appendChild(typingDiv);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }

        function hideTyping() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function generateReport() {
            if (chatHistory.length === 0) {
                showNotification('No conversation to report on', 'error');
                return;
            }

            const report = createReport();
            document.getElementById('report-content').innerHTML = report;
            document.getElementById('report-modal').style.display = 'flex';
        }

        function createReport() {
            const now = new Date();
            const duration = chatHistory.length > 0 ? 
                Math.round((chatHistory[chatHistory.length - 1].timestamp - chatHistory[0].timestamp) / 1000 / 60) : 0;
            
            const userMessages = chatHistory.filter(msg => msg.role === 'user');
            const assistantMessages = chatHistory.filter(msg => msg.role === 'assistant');
            
            let report = `
                <h2>üìä HKBU Learning Session Report</h2>
                <p><strong>Generated:</strong> ${now.toLocaleString()}</p>
                <p><strong>Duration:</strong> ${duration} minutes</p>
                <p><strong>Total Messages:</strong> ${chatHistory.length}</p>
                <p><strong>Your Messages:</strong> ${userMessages.length}</p>
                <p><strong>Assistant Responses:</strong> ${assistantMessages.length}</p>
                
                <h3>üí° Session Summary</h3>
                <p>${generateSummary()}</p>
                
                <h3>üìà Your Contribution Analysis</h3>
                <p>${analyzeContribution()}</p>
                
                <h3>üìù Complete Conversation</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
            `;
            
            chatHistory.forEach(msg => {
                report += `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${msg.role === 'user' ? '#e3f2fd' : '#f1f8e9'}; border-radius: 6px;">
                        <strong>${msg.role === 'user' ? 'üë§ You' : 'ü§ñ Assistant'}:</strong><br>
                        ${msg.content.replace(/\n/g, '<br>')}
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ${msg.timestamp.toLocaleTimeString()}
                        </div>
                    </div>
                `;
            });
            
            report += '</div>';
            
            // Add credits to report
            report += `
                <hr style="margin: 20px 0;">
                <div style="text-align: center; font-size: 0.9rem; color: #666;">
                    <strong>Created by:</strong> Dr. Simon Wang, Innovation Officer<br>
                    Language Centre, Hong Kong Baptist University<br>
                    <a href="mailto:simonwang@hkbu.edu.hk">simonwang@hkbu.edu.hk</a>
                </div>
            `;
            
            return report;
        }

        function generateSummary() {
            const topics = extractTopics();
            const questionsAsked = chatHistory.filter(msg => 
                msg.role === 'user' && msg.content.includes('?')
            ).length;
            
            return `This learning session covered ${topics.length > 0 ? topics.join(', ') : 'various topics'}. 
                    You asked ${questionsAsked} questions and engaged in ${Math.floor(chatHistory.length / 2)} conversation exchanges. 
                    The session demonstrated active learning through inquiry and discussion.`;
        }

        function analyzeContribution() {
            const userMessages = chatHistory.filter(msg => msg.role === 'user');
            if (userMessages.length === 0) return 'No user messages to analyze.';
            
            const avgLength = userMessages.reduce((sum, msg) => sum + msg.content.length, 0) / userMessages.length;
            const questionsRatio = userMessages.filter(msg => msg.content.includes('?')).length / userMessages.length;
            
            let analysis = '';
            
            if (avgLength > 100) {
                analysis += 'You provided detailed and thoughtful messages. ';
            } else if (avgLength > 50) {
                analysis += 'You engaged with good depth in your responses. ';
            } else {
                analysis += 'You kept your messages concise and focused. ';
            }
            
            if (questionsRatio > 0.5) {
                analysis += 'You showed excellent curiosity by asking many questions. ';
            } else if (questionsRatio > 0.2) {
                analysis += 'You balanced questions with statements effectively. ';
            }
            
            analysis += 'Your engagement shows a positive learning attitude and willingness to explore topics deeply.';
            
            return analysis;
        }

        function extractTopics() {
            const commonWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'must'];
            const allWords = chatHistory
                .filter(msg => msg.role === 'user')
                .map(msg => msg.content.toLowerCase())
                .join(' ')
                .replace(/[^\w\s]/g, '')
                .split(' ')
                .filter(word => word.length > 3 && !commonWords.includes(word));
            
            const wordCount = {};
            allWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            return Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([word]) => word);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('HKBU Learning Session Report', 20, 20);
            
            doc.setFontSize(12);
            let yPos = 40;
            
            const reportText = document.getElementById('report-content').innerText;
            const lines = doc.splitTextToSize(reportText, 170);
            
            lines.forEach(line => {
                if (yPos > 280) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(line, 20, yPos);
                yPos += 6;
            });
            
            doc.save(`HKBU_Learning_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function downloadMarkdown() {
            const report = createMarkdownReport();
            const blob = new Blob([report], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HKBU_Learning_Report_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createMarkdownReport() {
            const now = new Date();
            const duration = chatHistory.length > 0 ? 
                Math.round((chatHistory[chatHistory.length - 1].timestamp - chatHistory[0].timestamp) / 1000 / 60) : 0;
            
            let markdown = `# üìä HKBU Learning Session Report

**Generated:** ${now.toLocaleString()}
**Duration:** ${duration} minutes
**Total Messages:** ${chatHistory.length}

## üí° Session Summary

${generateSummary()}

## üìà Your Contribution Analysis

${analyzeContribution()}

## üìù Complete Conversation

`;
            
            chatHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'üë§ **You**' : 'ü§ñ **Assistant**';
                markdown += `### ${role} (${msg.timestamp.toLocaleTimeString()})\n\n${msg.content}\n\n`;
            });
            
            markdown += `---
*Created by: Dr. Simon Wang, Innovation Officer*  
*Language Centre, Hong Kong Baptist University*  
*simonwang@hkbu.edu.hk*`;
            
            return markdown;
        }

        function copyReport() {
            const reportText = document.getElementById('report-content').innerText;
            navigator.clipboard.writeText(reportText).then(() => {
                showNotification('Report copied to clipboard!', 'success');
            });
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // Cache utility functions
        function saveToCache(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Failed to save to cache:', error);
                return false;
            }
        }

        function loadFromCache(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Failed to load from cache:', error);
                return null;
            }
        }

        function clearCache(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error('Failed to clear cache:', error);
                return false;
            }
        }

        function encodeApiKey(key) {
            // Simple encoding (not encryption, just obfuscation)
            return btoa(key);
        }

        function decodeApiKey(encodedKey) {
            try {
                return atob(encodedKey);
            } catch (error) {
                return null;
            }
        }

        function saveApiKeyToCache() {
            if (userPreferences.rememberApiKey && apiKey) {
                const encodedKey = encodeApiKey(apiKey);
                saveToCache(STORAGE_KEYS.API_KEY, encodedKey);
            }
        }

        function loadApiKeyFromCache() {
            if (userPreferences.rememberApiKey) {
                const encodedKey = loadFromCache(STORAGE_KEYS.API_KEY);
                if (encodedKey) {
                    const decodedKey = decodeApiKey(encodedKey);
                    if (decodedKey) {
                        document.getElementById('api-key').value = decodedKey;
                        return decodedKey;
                    }
                }
            }
            return null;
        }

        function saveChatHistoryToCache() {
            if (userPreferences.saveConversations && chatHistory.length > 0) {
                const sessionData = {
                    messages: chatHistory,
                    startTime: chatHistory[0]?.timestamp || new Date(),
                    lastActivity: new Date(),
                    messageCount: chatHistory.length,
                    customPrompts: {
                        welcome: welcomePrompt,
                        system: systemPrompt
                    }
                };
                saveToCache(STORAGE_KEYS.CHAT_HISTORY, sessionData);
            }
        }

        function loadChatHistoryFromCache() {
            if (userPreferences.saveConversations) {
                return loadFromCache(STORAGE_KEYS.CHAT_HISTORY);
            }
            return null;
        }

        function savePreferencesToCache() {
            saveToCache(STORAGE_KEYS.PREFERENCES, userPreferences);
        }

        function loadPreferencesFromCache() {
            const savedPrefs = loadFromCache(STORAGE_KEYS.PREFERENCES);
            if (savedPrefs) {
                userPreferences = { ...userPreferences, ...savedPrefs };
            }
        }



        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
</body>
</html>