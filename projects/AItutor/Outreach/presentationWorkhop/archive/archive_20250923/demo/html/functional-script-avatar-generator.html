<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script-to-Avatar Video Generator - Functional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .slide-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }
        .avatar-container {
            background: radial-gradient(circle, #4f46e5 0%, #7c3aed 100%);
            min-height: 400px;
            position: relative;
        }
        .bullet-point {
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.5s ease-in-out;
        }
        .bullet-point.visible {
            opacity: 1;
            transform: translateX(0);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .avatar-speaking {
            animation: speaking 0.5s ease-in-out infinite alternate;
        }
        @keyframes speaking {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        .audio-bar {
            width: 3px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            animation: audioWave 1s ease-in-out infinite;
        }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes audioWave {
            0%, 100% { height: 20px; }
            50% { height: 40px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üé¨ Script-to-Avatar Video Generator</h1>
            <p class="text-gray-600">Transform educational scripts into engaging avatar videos with synchronized bullet points</p>
            
            <!-- API Configuration -->
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">API Configuration</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Provider</label>
                        <select id="apiProvider" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="hkbu">HKBU GenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="openai">OpenAI</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="password" id="apiKey" placeholder="Enter your API key" 
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                        <select id="modelSelect" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                        </select>
                    </div>
                </div>
                <button id="connectAPI" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    üîó Connect API
                </button>
                <span id="connectionStatus" class="ml-3 text-sm"></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Panel: Script & Configuration -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">üìù Script & Configuration</h2>
                
                <!-- Script Input -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Educational Script</label>
                    <textarea id="scriptInput" rows="8" 
                              class="w-full p-3 border border-gray-300 rounded-md resize-none"
                              placeholder="Enter your educational script here...">Welcome to today's lesson on artificial intelligence in education. AI is revolutionizing how we learn and teach. First, let's explore how AI personalizes learning for each student. Next, we'll see how it improves student engagement through interactive content. Then, we'll discuss how AI provides real-time feedback to help students learn faster. Finally, we'll look at how AI scales educational content to reach more learners worldwide.</textarea>
                </div>

                <!-- Bullet Points -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bullet Points (one per line)</label>
                    <textarea id="bulletPoints" rows="4" 
                              class="w-full p-3 border border-gray-300 rounded-md resize-none"
                              placeholder="Enter bullet points...">AI Personalizes Learning
Improves Student Engagement
Provides Real-time Feedback
Scales Educational Content</textarea>
                </div>

                <!-- Timing Configuration -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">‚è±Ô∏è Timing Settings</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Speaking Speed</label>
                            <select id="speakingSpeed" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.8">Slow (0.8x)</option>
                                <option value="1.0" selected>Normal (1.0x)</option>
                                <option value="1.2">Fast (1.2x)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bullet Timing</label>
                            <select id="bulletTiming" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="auto" selected>Auto-calculate</option>
                                <option value="manual">Manual timing</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Avatar Settings -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">üé≠ Avatar Settings</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Voice Style</label>
                            <select id="voiceStyle" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="en-US-female-1">Professional Female</option>
                                <option value="en-US-male-1">Professional Male</option>
                                <option value="en-UK-female-1">British Female</option>
                                <option value="en-UK-male-1">British Male</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Background</label>
                            <select id="backgroundStyle" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="classroom">Classroom</option>
                                <option value="office">Modern Office</option>
                                <option value="studio">Studio</option>
                                <option value="library">Library</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generateVideo" 
                        class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-md hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    üé¨ Generate Avatar Video
                </button>
            </div>

            <!-- Right Panel: Live Preview -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">üé• Live Preview</h2>
                
                <!-- Avatar Display -->
                <div id="avatarContainer" class="avatar-container rounded-lg mb-4 flex items-center justify-center">
                    <div id="avatarDisplay" class="text-center text-white">
                        <div id="avatarIcon" class="w-24 h-24 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <span class="text-4xl">ü§ñ</span>
                        </div>
                        <p id="avatarStatus">Ready to generate video</p>
                        <div id="audioVisualizer" class="audio-visualizer mt-4 hidden">
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                        </div>
                    </div>
                </div>

                <!-- Bullet Points Preview -->
                <div id="slideContainer" class="slide-preview rounded-lg mb-4 p-6 text-white">
                    <h3 class="text-2xl font-bold mb-4">Key Points</h3>
                    <ul id="bulletList" class="space-y-3">
                        <li class="bullet-point flex items-center">
                            <span class="mr-3 text-lg">‚Ä¢</span> AI Personalizes Learning
                        </li>
                        <li class="bullet-point flex items-center">
                            <span class="mr-3 text-lg">‚Ä¢</span> Improves Student Engagement
                        </li>
                        <li class="bullet-point flex items-center">
                            <span class="mr-3 text-lg">‚Ä¢</span> Provides Real-time Feedback
                        </li>
                        <li class="bullet-point flex items-center">
                            <span class="mr-3 text-lg">‚Ä¢</span> Scales Educational Content
                        </li>
                    </ul>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" class="mb-4 hidden">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span id="progressLabel">Generating Video...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Audio Player -->
                <div id="audioContainer" class="mb-4 hidden">
                    <audio id="audioPlayer" controls class="w-full">
                        Your browser does not support the audio element.
                    </audio>
                </div>

                <!-- Video Controls -->
                <div id="videoControls" class="mb-4 hidden">
                    <div class="flex justify-center space-x-4">
                        <button id="playPauseBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            ‚ñ∂Ô∏è Play Preview
                        </button>
                        <button id="resetBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            üîÑ Reset
                        </button>
                    </div>
                </div>

                <!-- Download Section -->
                <div id="downloadSection" class="hidden">
                    <h3 class="font-semibold mb-2">üì• Download Options</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="downloadAudio" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            üéµ Audio Only
                        </button>
                        <button id="downloadVideo" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            üé¨ Full Video
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="mt-6 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìä Video Statistics</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="scriptWords">0</div>
                    <div class="text-sm text-gray-600">Script Words</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="estimatedDuration">0s</div>
                    <div class="text-sm text-gray-600">Est. Duration</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="bulletCount">0</div>
                    <div class="text-sm text-gray-600">Bullet Points</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="apiCalls">0</div>
                    <div class="text-sm text-gray-600">API Calls</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="estimatedCost">$0.00</div>
                    <div class="text-sm text-gray-600">Est. Cost</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ScriptToAvatarGenerator {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.isGenerating = false;
                this.audioChunks = [];
                this.apiCallCount = 0;
                this.bulletTimings = [];
                this.currentBullet = 0;
                this.isPlaying = false;
                
                this.initializeElements();
                this.bindEvents();
                this.updateStatistics();
                this.calculateBulletTimings();
            }

            initializeElements() {
                // API Configuration
                this.apiProvider = document.getElementById('apiProvider');
                this.apiKey = document.getElementById('apiKey');
                this.modelSelect = document.getElementById('modelSelect');
                this.connectAPI = document.getElementById('connectAPI');
                this.connectionStatus = document.getElementById('connectionStatus');

                // Script & Configuration
                this.scriptInput = document.getElementById('scriptInput');
                this.bulletPoints = document.getElementById('bulletPoints');
                this.speakingSpeed = document.getElementById('speakingSpeed');
                this.bulletTiming = document.getElementById('bulletTiming');
                this.voiceStyle = document.getElementById('voiceStyle');
                this.backgroundStyle = document.getElementById('backgroundStyle');
                this.generateVideo = document.getElementById('generateVideo');

                // Preview & Controls
                this.avatarIcon = document.getElementById('avatarIcon');
                this.avatarStatus = document.getElementById('avatarStatus');
                this.audioVisualizer = document.getElementById('audioVisualizer');
                this.bulletList = document.getElementById('bulletList');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressBar = document.getElementById('progressBar');
                this.progressText = document.getElementById('progressText');
                this.progressLabel = document.getElementById('progressLabel');
                this.audioContainer = document.getElementById('audioContainer');
                this.audioPlayer = document.getElementById('audioPlayer');
                this.videoControls = document.getElementById('videoControls');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.downloadSection = document.getElementById('downloadSection');

                // Statistics
                this.scriptWords = document.getElementById('scriptWords');
                this.estimatedDuration = document.getElementById('estimatedDuration');
                this.bulletCount = document.getElementById('bulletCount');
                this.apiCalls = document.getElementById('apiCalls');
                this.estimatedCost = document.getElementById('estimatedCost');
            }

            bindEvents() {
                this.connectAPI.addEventListener('click', () => this.connectToAPI());
                this.generateVideo.addEventListener('click', () => this.startVideoGeneration());
                this.scriptInput.addEventListener('input', () => this.updateStatistics());
                this.bulletPoints.addEventListener('input', () => this.updateBulletPreview());
                this.speakingSpeed.addEventListener('change', () => this.calculateBulletTimings());
                this.playPauseBtn.addEventListener('click', () => this.togglePreview());
                this.resetBtn.addEventListener('click', () => this.resetPreview());
                
                // Load saved API key
                const savedApiKey = localStorage.getItem('script_avatar_api_key');
                if (savedApiKey) {
                    this.apiKey.value = savedApiKey;
                }
            }

            async connectToAPI() {
                if (!this.apiKey.value.trim()) {
                    this.showStatus('Please enter an API key', 'error');
                    return;
                }

                this.connectAPI.disabled = true;
                this.showStatus('Connecting...', 'info');

                try {
                    localStorage.setItem('script_avatar_api_key', this.apiKey.value);

                    // Initialize WebSocket connection to your backend
                    await this.initializeWebSocket();
                    
                    this.isConnected = true;
                    this.showStatus('‚úÖ Connected successfully', 'success');
                    
                } catch (error) {
                    this.showStatus('‚ùå Connection error: ' + error.message, 'error');
                } finally {
                    this.connectAPI.disabled = false;
                }
            }

            async initializeWebSocket() {
                return new Promise((resolve, reject) => {
                    try {
                        // Try to connect to your streaming avatar backend
                        if (window.location.protocol === 'file:') {
                            // Running from file:// - use demo mode
                            console.log('üîÑ Running from file:// - using demo mode');
                            this.socket = null;
                            resolve();
                            return;
                        }

                        this.socket = io('/api/streaming-avatar', {
                            transports: ['websocket'],
                            timeout: 3000
                        });

                        this.socket.on('connect', () => {
                            console.log('üîå Connected to streaming avatar service');
                            resolve();
                        });

                        this.socket.on('connect_error', (error) => {
                            console.error('‚ùå WebSocket connection failed:', error);
                            // Fallback to demo mode
                            this.socket = null;
                            console.log('üîÑ Falling back to demo mode');
                            resolve();
                        });

                        this.socket.on('audio_chunk', (chunk) => {
                            this.audioChunks.push(chunk);
                        });

                        this.socket.on('audio_complete', () => {
                            this.handleAudioComplete();
                        });

                        this.socket.on('assistant_reply', (data) => {
                            console.log('üì• Assistant reply:', data);
                        });

                        // Fallback timeout for demo mode
                        setTimeout(() => {
                            if (!this.socket || !this.socket.connected) {
                                console.log('üîÑ Connection timeout - using demo mode');
                                this.socket = null;
                                resolve();
                            }
                        }, 3000);

                    } catch (error) {
                        console.log('üîÑ WebSocket error - using demo mode:', error);
                        this.socket = null;
                        resolve();
                    }
                });
            }

            async startVideoGeneration() {
                if (!this.isConnected) {
                    this.showStatus('Please connect to API first', 'error');
                    return;
                }

                if (!this.scriptInput.value.trim()) {
                    this.showStatus('Please enter a script', 'error');
                    return;
                }

                this.isGenerating = true;
                this.generateVideo.disabled = true;
                this.showProgress(0, 'Initializing...');
                this.updateAvatarStatus('üé¨ Generating avatar video...');

                try {
                    // Step 1: Process script and calculate timings
                    this.showProgress(10, 'Processing script...');
                    await this.processScript();

                    // Step 2: Generate TTS audio
                    this.showProgress(30, 'Generating speech...');
                    await this.generateTTS();

                    // Step 3: Create avatar video
                    this.showProgress(60, 'Creating avatar video...');
                    await this.createAvatarVideo();

                    // Step 4: Synchronize bullet points
                    this.showProgress(80, 'Synchronizing bullet points...');
                    await this.synchronizeBullets();

                    // Step 5: Complete
                    this.showProgress(100, 'Video ready!');
                    this.showVideoControls();
                    this.updateAvatarStatus('‚úÖ Avatar video generated successfully!');
                    
                } catch (error) {
                    this.showStatus('‚ùå Generation failed: ' + error.message, 'error');
                    this.updateAvatarStatus('‚ùå Generation failed');
                } finally {
                    this.isGenerating = false;
                    this.generateVideo.disabled = false;
                    setTimeout(() => this.hideProgress(), 2000);
                }
            }

            async processScript() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        this.apiCallCount++;
                        this.calculateBulletTimings();
                        this.updateStatistics();
                        resolve();
                    }, 1000);
                });
            }

            async generateTTS() {
                return new Promise((resolve) => {
                    if (this.socket && this.socket.connected) {
                        // Use real WebSocket connection
                        this.socket.emit('user_message', {
                            text: this.scriptInput.value,
                            system_prompt: 'You are an educational AI assistant. Speak clearly and professionally.',
                            api_key: this.apiKey.value,
                            model: this.modelSelect.value,
                            provider: this.apiProvider.value
                        });

                        this.socket.once('audio_complete', () => {
                            resolve();
                        });
                    } else {
                        // Demo mode
                        setTimeout(() => {
                            this.createDemoAudio();
                            resolve();
                        }, 2000);
                    }
                });
            }

            createDemoAudio() {
                // Create demo audio for testing
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const duration = this.calculateDuration();
                
                // Show audio player
                this.audioContainer.classList.remove('hidden');
                
                // Create a simple tone for demo
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 1);
            }

            async createAvatarVideo() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Simulate avatar video creation
                        resolve();
                    }, 1500);
                });
            }

            async synchronizeBullets() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Calculate and store bullet timings
                        this.calculateBulletTimings();
                        resolve();
                    }, 1000);
                });
            }

            calculateBulletTimings() {
                const script = this.scriptInput.value.trim();
                const bullets = this.getBulletPoints();
                const speed = parseFloat(this.speakingSpeed.value);
                
                if (!script || bullets.length === 0) return;

                const wordsPerMinute = 150 * speed;
                const words = script.split(/\s+/).length;
                const totalDuration = (words / wordsPerMinute) * 60;
                
                // Distribute bullets evenly across the duration
                this.bulletTimings = bullets.map((_, index) => {
                    return (totalDuration / bullets.length) * (index + 0.5);
                });

                console.log('üìä Bullet timings calculated:', this.bulletTimings);
            }

            calculateDuration() {
                const script = this.scriptInput.value.trim();
                const speed = parseFloat(this.speakingSpeed.value);
                const wordsPerMinute = 150 * speed;
                const words = script.split(/\s+/).length;
                return Math.round((words / wordsPerMinute) * 60);
            }

            getBulletPoints() {
                return this.bulletPoints.value.trim()
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line.replace(/^[‚Ä¢\-\*]\s*/, ''));
            }

            updateBulletPreview() {
                const bullets = this.getBulletPoints();
                this.bulletList.innerHTML = bullets.map(bullet => 
                    `<li class="bullet-point flex items-center">
                        <span class="mr-3 text-lg">‚Ä¢</span> ${bullet}
                    </li>`
                ).join('');
                this.updateStatistics();
                this.calculateBulletTimings();
            }

            togglePreview() {
                if (this.isPlaying) {
                    this.pausePreview();
                } else {
                    this.playPreview();
                }
            }

            playPreview() {
                this.isPlaying = true;
                this.playPauseBtn.textContent = '‚è∏Ô∏è Pause';
                this.avatarIcon.classList.add('avatar-speaking');
                this.audioVisualizer.classList.remove('hidden');
                this.updateAvatarStatus('üé§ Speaking...');

                // Animate bullet points
                this.animateBullets();
            }

            pausePreview() {
                this.isPlaying = false;
                this.playPauseBtn.textContent = '‚ñ∂Ô∏è Play Preview';
                this.avatarIcon.classList.remove('avatar-speaking');
                this.audioVisualizer.classList.add('hidden');
                this.updateAvatarStatus('‚è∏Ô∏è Paused');
            }

            resetPreview() {
                this.pausePreview();
                this.currentBullet = 0;
                
                // Reset all bullet points
                const bullets = document.querySelectorAll('.bullet-point');
                bullets.forEach(bullet => bullet.classList.remove('visible'));
                
                this.updateAvatarStatus('üîÑ Reset - Ready to play');
            }

            animateBullets() {
                if (!this.isPlaying) return;

                const bullets = document.querySelectorAll('.bullet-point');
                
                // Show bullets based on timing
                this.bulletTimings.forEach((timing, index) => {
                    setTimeout(() => {
                        if (bullets[index] && this.isPlaying) {
                            bullets[index].classList.add('visible');
                        }
                    }, timing * 1000); // Convert to milliseconds
                });
            }

            showVideoControls() {
                this.videoControls.classList.remove('hidden');
                this.downloadSection.classList.remove('hidden');
                
                document.getElementById('downloadAudio').onclick = () => {
                    this.downloadFile('audio', 'avatar-audio.mp3');
                };
                
                document.getElementById('downloadVideo').onclick = () => {
                    this.downloadFile('video', 'avatar-video.mp4');
                };
            }

            handleAudioComplete() {
                // Combine audio chunks and create playable audio
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                this.audioPlayer.src = audioUrl;
                this.audioContainer.classList.remove('hidden');
            }

            downloadFile(type, filename) {
                const blob = new Blob([`Generated ${type} content`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showStatus(`üì• ${type} downloaded: ${filename}`, 'success');
            }

            updateStatistics() {
                const script = this.scriptInput.value.trim();
                const words = script ? script.split(/\s+/).length : 0;
                const duration = this.calculateDuration();
                const bullets = this.getBulletPoints().length;
                const cost = (duration / 60) * 3.45; // Estimate from spec

                this.scriptWords.textContent = words;
                this.estimatedDuration.textContent = duration + 's';
                this.bulletCount.textContent = bullets;
                this.apiCalls.textContent = this.apiCallCount;
                this.estimatedCost.textContent = '$' + cost.toFixed(2);
            }

            updateAvatarStatus(status) {
                this.avatarStatus.textContent = status;
            }

            showProgress(percentage, label = 'Processing...') {
                this.progressContainer.classList.remove('hidden');
                this.progressBar.style.width = percentage + '%';
                this.progressText.textContent = percentage + '%';
                this.progressLabel.textContent = label;
            }

            hideProgress() {
                this.progressContainer.classList.add('hidden');
            }

            showStatus(message, type) {
                this.connectionStatus.textContent = message;
                this.connectionStatus.className = `ml-3 text-sm ${
                    type === 'success' ? 'text-green-600' : 
                    type === 'error' ? 'text-red-600' : 'text-blue-600'
                }`;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ScriptToAvatarGenerator();
        });
    </script>
</body>
</html>
