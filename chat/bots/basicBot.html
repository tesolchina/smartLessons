<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKBU Basic Chat Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 90vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .prompt-section {
            margin-bottom: 20px;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .prompt-header h3 {
            font-size: 1rem;
            color: #333;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .prompt-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .prompt-content {
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .prompt-content.hidden {
            display: none;
        }

        .prompt-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .prompt-editor {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            font-family: inherit;
            resize: vertical;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }

        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-key-input {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 300px;
        }

        .api-key-input::placeholder { color: rgba(255,255,255,0.7); }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user { flex-direction: row-reverse; }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-right: 10px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            margin-left: 10px;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 45px;
        }

        .chat-input:focus { border-color: #667eea; }

        .input-buttons {
            display: flex;
            gap: 10px;
        }

        .send-btn, .done-btn {
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .done-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .send-btn:hover, .done-btn:hover { transform: scale(1.05); }
        .send-btn:disabled, .done-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .report-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ü§ñ Chat Assistant</h2>
                <p>Customize your learning experience</p>
            </div>
            
            <div class="sidebar-content">
                <!-- Welcome Prompt Section -->
                <div class="prompt-section">
                    <div class="prompt-header" onclick="togglePrompt('welcome')">
                        <h3>üìù Welcome Message</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-content" id="welcome-content">
                        <div class="prompt-display" id="welcome-display"></div>
                        <button class="btn btn-primary" onclick="editPrompt('welcome')">Edit Welcome</button>
                        <button class="btn btn-secondary" onclick="resetPrompt('welcome')">Reset</button>
                    </div>
                </div>

                <!-- System Prompt Section -->
                <div class="prompt-section">
                    <div class="prompt-header" onclick="togglePrompt('system')">
                        <h3>‚öôÔ∏è System Instructions</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-content" id="system-content">
                        <div class="prompt-display" id="system-display"></div>
                        <button class="btn btn-primary" onclick="editPrompt('system')">Edit System</button>
                        <button class="btn btn-secondary" onclick="resetPrompt('system')">Reset</button>
                        <div class="mt-2">
                            <small style="color: #666;">üí° Try roles like: Math Tutor, Writing Coach, Research Assistant, Language Partner</small>
                        </div>
                    </div>
                </div>

                <!-- API Configuration -->
                <div class="prompt-section">
                    <div class="prompt-header" onclick="togglePrompt('api')">
                        <h3>üîë API Configuration</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-content" id="api-content">
                        <input type="password" id="api-key" placeholder="Enter HKBU GenAI API Key" 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <button class="btn btn-success" onclick="connectAPI()">Connect</button>
                        <div id="connection-status" style="margin-top: 10px; font-size: 0.8rem;"></div>
                        <small style="color: #666;">Get your key at: <a href="https://genai.hkbu.edu.hk/settings/api-docs" target="_blank">HKBU GenAI</a></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h1>HKBU Learning Assistant</h1>
                <div style="font-size: 0.9rem; opacity: 0.9;">
                    üí° Customize prompts, chat, and generate learning reports
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <!-- Messages will appear here -->
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="message-input" 
                        placeholder="Type your message here... (Enter to send)"
                        rows="1"
                        disabled
                    ></textarea>
                    <div class="input-buttons">
                        <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled title="Send Message">
                            ‚û§
                        </button>
                        <button class="done-btn" id="done-btn" onclick="generateReport()" disabled title="Generate Report">
                            ‚úì
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-content">
            <button class="close-btn" onclick="closeReport()">&times;</button>
            <div id="report-content">
                <!-- Report will be generated here -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button class="btn btn-primary" onclick="downloadMarkdown()">üìù Download Markdown</button>
                <button class="btn btn-secondary" onclick="copyReport()">üìã Copy Text</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chatHistory = [];
        let isConnected = false;
        let apiKey = '';
        let welcomePrompt = '';
        let systemPrompt = '';
        let defaultWelcome = '';
        let defaultSystem = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPrompts();
            setupEventListeners();
            showWelcomeMessage();
        });

        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        async function loadPrompts() {
            try {
                // For now, use default prompts since we can't directly read files from browser
                defaultWelcome = `Welcome to the HKBU Learning Assistant! üéì

I'm here to help you explore various topics and enhance your learning experience. You can customize my behavior by editing the system prompt below.

üîß **How to customize:**
- Click 'Edit System Prompt' to modify my personality and expertise
- Try different roles: tutor, writing coach, research assistant, etc.
- Experiment with different teaching styles

üí° **Tips:**
- Ask me to explain concepts step-by-step
- Request examples and practice problems
- Get help with assignments and projects

When you're done with our conversation, click 'Done' to generate a comprehensive learning report!

Let's start learning together!`;

                defaultSystem = `You are a knowledgeable and friendly educational assistant for HKBU students. Your role is to:

1. **Teaching Style**: Explain concepts clearly with examples, encourage critical thinking, and adapt to different learning styles.

2. **Subject Expertise**: Help with various academic subjects including language learning, sciences, humanities, and general study skills.

3. **Interaction Approach**: 
   - Ask clarifying questions to understand student needs
   - Provide step-by-step explanations
   - Encourage students to think through problems
   - Offer constructive feedback and encouragement

4. **Learning Support**: 
   - Break down complex topics into manageable parts
   - Suggest additional resources when helpful
   - Help students develop study strategies
   - Foster independent learning skills

5. **Communication**: Be encouraging, patient, and supportive. Use clear language appropriate for university-level students.

Remember: Guide students toward understanding rather than simply providing answers.`;

                welcomePrompt = defaultWelcome;
                systemPrompt = defaultSystem;
                
                updatePromptDisplay('welcome');
                updatePromptDisplay('system');
                
            } catch (error) {
                console.error('Error loading prompts:', error);
                showNotification('Using default prompts', 'info');
            }
        }

        function togglePrompt(section) {
            const content = document.getElementById(section + '-content');
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            content.classList.toggle('hidden');
            header.classList.toggle('collapsed');
        }

        function updatePromptDisplay(type) {
            const display = document.getElementById(type + '-display');
            const prompt = type === 'welcome' ? welcomePrompt : systemPrompt;
            display.textContent = prompt;
        }

        function editPrompt(type) {
            const display = document.getElementById(type + '-display');
            const currentText = type === 'welcome' ? welcomePrompt : systemPrompt;
            
            const textarea = document.createElement('textarea');
            textarea.className = 'prompt-editor';
            textarea.value = currentText;
            
            display.parentNode.replaceChild(textarea, display);
            
            // Replace buttons
            const buttonsContainer = textarea.nextElementSibling;
            buttonsContainer.innerHTML = `
                <button class="btn btn-success" onclick="savePrompt('${type}')">Save</button>
                <button class="btn btn-secondary" onclick="cancelEdit('${type}')">Cancel</button>
            `;
            
            textarea.focus();
        }

        function savePrompt(type) {
            const textarea = document.querySelector('.prompt-editor');
            const newText = textarea.value;
            
            if (type === 'welcome') {
                welcomePrompt = newText;
            } else {
                systemPrompt = newText;
            }
            
            cancelEdit(type);
            showNotification(`${type === 'welcome' ? 'Welcome' : 'System'} prompt updated! (Resets on page refresh)`, 'success');
        }

        function cancelEdit(type) {
            const textarea = document.querySelector('.prompt-editor');
            const display = document.createElement('div');
            display.className = 'prompt-display';
            display.id = type + '-display';
            
            textarea.parentNode.replaceChild(display, textarea);
            
            // Restore buttons
            const buttonsContainer = display.nextElementSibling;
            buttonsContainer.innerHTML = `
                <button class="btn btn-primary" onclick="editPrompt('${type}')">Edit ${type === 'welcome' ? 'Welcome' : 'System'}</button>
                <button class="btn btn-secondary" onclick="resetPrompt('${type}')">Reset</button>
                ${type === 'system' ? '<div class="mt-2"><small style="color: #666;">üí° Try roles like: Math Tutor, Writing Coach, Research Assistant, Language Partner</small></div>' : ''}
            `;
            
            updatePromptDisplay(type);
        }

        function resetPrompt(type) {
            if (type === 'welcome') {
                welcomePrompt = defaultWelcome;
            } else {
                systemPrompt = defaultSystem;
            }
            updatePromptDisplay(type);
            showNotification(`${type === 'welcome' ? 'Welcome' : 'System'} prompt reset to default`, 'info');
        }

        async function connectAPI() {
            const key = document.getElementById('api-key').value.trim();
            const statusDiv = document.getElementById('connection-status');
            
            if (!key) {
                showNotification('Please enter an API key', 'error');
                return;
            }

            statusDiv.innerHTML = 'üîÑ Testing connection...';
            
            try {
                const response = await fetch('https://smartlessons-production.up.railway.app/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: key,
                        provider: 'hkbu',
                        model: 'gpt-4.1'
                    })
                });

                const data = await response.json();

                if (response.ok && !data.error) {
                    apiKey = key;
                    isConnected = true;
                    statusDiv.innerHTML = '‚úÖ Connected successfully!';
                    document.getElementById('message-input').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                    showNotification('API connected successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Connection failed');
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Connection failed';
                showNotification(`Connection failed: ${error.message}`, 'error');
            }
        }

        function showWelcomeMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">${welcomePrompt.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }

        async function sendMessage() {
            if (!isConnected) {
                showNotification('Please connect your API key first', 'error');
                return;
            }

            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage('user', message);
            chatHistory.push({ role: 'user', content: message, timestamp: new Date() });
            
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            showTyping();
            
            try {
                const response = await fetch('https://smartlessons-production.up.railway.app/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        apiKey: apiKey,
                        provider: 'hkbu',
                        model: 'gpt-4.1',
                        systemPrompt: systemPrompt
                    })
                });

                const data = await response.json();
                hideTyping();

                if (response.ok && !data.error) {
                    addMessage('assistant', data.response);
                    chatHistory.push({ role: 'assistant', content: data.response, timestamp: new Date() });
                    document.getElementById('done-btn').disabled = false;
                } else {
                    addMessage('error', `Error: ${data.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                hideTyping();
                addMessage('error', `Network error: ${error.message}`);
            }
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            messageDiv.innerHTML = `
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = '<div class="message-content">ü§ñ Thinking...</div>';
            
            document.getElementById('chat-messages').appendChild(typingDiv);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }

        function hideTyping() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function generateReport() {
            if (chatHistory.length === 0) {
                showNotification('No conversation to report on', 'error');
                return;
            }

            const report = createReport();
            document.getElementById('report-content').innerHTML = report;
            document.getElementById('report-modal').style.display = 'flex';
        }

        function createReport() {
            const now = new Date();
            const duration = chatHistory.length > 0 ? 
                Math.round((chatHistory[chatHistory.length - 1].timestamp - chatHistory[0].timestamp) / 1000 / 60) : 0;
            
            const userMessages = chatHistory.filter(msg => msg.role === 'user');
            const assistantMessages = chatHistory.filter(msg => msg.role === 'assistant');
            
            let report = `
                <h2>üìä Learning Session Report</h2>
                <p><strong>Generated:</strong> ${now.toLocaleString()}</p>
                <p><strong>Duration:</strong> ${duration} minutes</p>
                <p><strong>Total Messages:</strong> ${chatHistory.length}</p>
                <p><strong>Your Messages:</strong> ${userMessages.length}</p>
                <p><strong>Assistant Responses:</strong> ${assistantMessages.length}</p>
                
                <h3>üí° Session Summary</h3>
                <p>${generateSummary()}</p>
                
                <h3>üìà Your Contribution Analysis</h3>
                <p>${analyzeContribution()}</p>
                
                <h3>üìù Complete Conversation</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
            `;
            
            chatHistory.forEach(msg => {
                report += `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${msg.role === 'user' ? '#e3f2fd' : '#f1f8e9'}; border-radius: 6px;">
                        <strong>${msg.role === 'user' ? 'üë§ You' : 'ü§ñ Assistant'}:</strong><br>
                        ${msg.content.replace(/\n/g, '<br>')}
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            ${msg.timestamp.toLocaleTimeString()}
                        </div>
                    </div>
                `;
            });
            
            report += '</div>';
            return report;
        }

        function generateSummary() {
            const topics = extractTopics();
            const questionsAsked = chatHistory.filter(msg => 
                msg.role === 'user' && msg.content.includes('?')
            ).length;
            
            return `This learning session covered ${topics.length > 0 ? topics.join(', ') : 'various topics'}. 
                    You asked ${questionsAsked} questions and engaged in ${Math.floor(chatHistory.length / 2)} conversation exchanges. 
                    The session demonstrated active learning through inquiry and discussion.`;
        }

        function analyzeContribution() {
            const userMessages = chatHistory.filter(msg => msg.role === 'user');
            const avgLength = userMessages.reduce((sum, msg) => sum + msg.content.length, 0) / userMessages.length;
            const questionsRatio = userMessages.filter(msg => msg.content.includes('?')).length / userMessages.length;
            
            let analysis = '';
            
            if (avgLength > 100) {
                analysis += 'You provided detailed and thoughtful messages. ';
            } else if (avgLength > 50) {
                analysis += 'You engaged with good depth in your responses. ';
            } else {
                analysis += 'You kept your messages concise and focused. ';
            }
            
            if (questionsRatio > 0.5) {
                analysis += 'You showed excellent curiosity by asking many questions. ';
            } else if (questionsRatio > 0.2) {
                analysis += 'You balanced questions with statements effectively. ';
            }
            
            analysis += 'Your engagement shows a positive learning attitude and willingness to explore topics deeply.';
            
            return analysis;
        }

        function extractTopics() {
            // Simple keyword extraction
            const commonWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'can', 'may', 'might', 'must'];
            const allWords = chatHistory
                .filter(msg => msg.role === 'user')
                .map(msg => msg.content.toLowerCase())
                .join(' ')
                .replace(/[^\w\s]/g, '')
                .split(' ')
                .filter(word => word.length > 3 && !commonWords.includes(word));
            
            const wordCount = {};
            allWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            return Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([word]) => word);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('HKBU Learning Session Report', 20, 20);
            
            doc.setFontSize(12);
            let yPos = 40;
            
            const reportText = document.getElementById('report-content').innerText;
            const lines = doc.splitTextToSize(reportText, 170);
            
            lines.forEach(line => {
                if (yPos > 280) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(line, 20, yPos);
                yPos += 6;
            });
            
            doc.save(`HKBU_Learning_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function downloadMarkdown() {
            const report = createMarkdownReport();
            const blob = new Blob([report], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HKBU_Learning_Report_${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createMarkdownReport() {
            const now = new Date();
            const duration = chatHistory.length > 0 ? 
                Math.round((chatHistory[chatHistory.length - 1].timestamp - chatHistory[0].timestamp) / 1000 / 60) : 0;
            
            let markdown = `# üìä HKBU Learning Session Report

**Generated:** ${now.toLocaleString()}
**Duration:** ${duration} minutes
**Total Messages:** ${chatHistory.length}

## üí° Session Summary

${generateSummary()}

## üìà Your Contribution Analysis

${analyzeContribution()}

## üìù Complete Conversation

`;
            
            chatHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'üë§ **You**' : 'ü§ñ **Assistant**';
                markdown += `### ${role} (${msg.timestamp.toLocaleTimeString()})\n\n${msg.content}\n\n`;
            });
            
            markdown += `---
*Report generated by HKBU Learning Assistant*`;
            
            return markdown;
        }

        function copyReport() {
            const reportText = document.getElementById('report-content').innerText;
            navigator.clipboard.writeText(reportText).then(() => {
                showNotification('Report copied to clipboard!', 'success');
            });
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
</body>
</html>